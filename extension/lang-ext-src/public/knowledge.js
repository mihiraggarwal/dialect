
// Schema type
const graphData ={
    "clusters": [
      {
        "id": "miscellaneous",
        "label": "Miscellaneous",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "berman",
            "label": "berman",
            "word": "berman"
          },
          {
            "id": "russell",
            "label": "russell",
            "word": "russell"
          },
          {
            "id": "trump",
            "label": "trump",
            "word": "trump"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8ee9"
        }
      },
      {
        "id": "months",
        "label": "Months",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "marzo",
            "label": "marzo",
            "word": "march"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8eea"
        }
      },
      {
        "id": "numbers",
        "label": "Numbers",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "20",
            "label": "20",
            "word": "20"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8eeb"
        }
      },
      {
        "id": "years",
        "label": "Years",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "2017",
            "label": "2017",
            "word": "2017"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8eec"
        }
      },
      {
        "id": "verbs",
        "label": "Verbs",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "requests",
            "label": "Requests",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "preguntó",
                "label": "preguntó",
                "word": "asked"
              }
            ]
          },
          {
            "id": "increasing",
            "label": "Increasing",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "elevando",
                "label": "elevando",
                "word": "elevating"
              }
            ]
          },
          {
            "id": "legal",
            "label": "Legal",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "acusado",
                "label": "acusado",
                "word": "indicted"
              }
            ]
          },
          {
            "id": "destruction",
            "label": "Destruction",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "irrumpió",
                "label": "irrumpió",
                "word": "broke"
              }
            ]
          },
          {
            "id": "politics",
            "label": "Politics",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "socavar",
                "label": "socavar",
                "word": "subvert"
              }
            ]
          },
          {
            "id": "hiding",
            "label": "Hiding",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "ocultando",
                "label": "ocultando",
                "word": "concealing"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8eed"
        }
      },
      {
        "id": "articles",
        "label": "Articles",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "el",
            "label": "el",
            "word": "the"
          },
          {
            "id": "un",
            "label": "un",
            "word": "a"
          },
          {
            "id": "la",
            "label": "la",
            "word": "the"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8eee"
        }
      },
      {
        "id": "government",
        "label": "Government",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "judiciary",
            "label": "Judiciary",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "tribunal",
                "label": "tribunal",
                "word": "court"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8eef"
        }
      },
      {
        "id": "prepositions",
        "label": "Prepositions",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "a",
            "label": "a",
            "word": "to"
          },
          {
            "id": "con",
            "label": "con",
            "word": "with"
          },
          {
            "id": "en",
            "label": "en",
            "word": "on"
          },
          {
            "id": "contra",
            "label": "contra",
            "word": "against"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef0"
        }
      },
      {
        "id": "pronouns",
        "label": "Pronouns",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "possessives",
            "label": "Possessives",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "su",
                "label": "su",
                "word": "his"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef1"
        }
      },
      {
        "id": "nouns",
        "label": "Nouns",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "status",
            "label": "Status",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "posición",
                "label": "posición",
                "word": "standing"
              }
            ]
          },
          {
            "id": "relationships",
            "label": "Relationships",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "conexión",
                "label": "conexión",
                "word": "connection"
              }
            ]
          },
          {
            "id": "activities",
            "label": "Activities",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "acción",
                "label": "acción",
                "word": "action"
              }
            ]
          },
          {
            "id": "records",
            "label": "Records",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "documentos",
                "label": "documentos",
                "word": "documents"
              }
            ]
          },
          {
            "id": "documents",
            "label": "Documents",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "registros",
                "label": "registros",
                "word": "records"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef2"
        }
      },
      {
        "id": "law",
        "label": "Law",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "judiciary",
            "label": "Judiciary",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "jurado",
                "label": "jurado",
                "word": "jury"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef3"
        }
      },
      {
        "id": "structures",
        "label": "Structures",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "buildings",
            "label": "Buildings",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "edificio",
                "label": "edificio",
                "word": "building"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef4"
        }
      },
      {
        "id": "politics",
        "label": "Politics",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "parties",
            "label": "Parties",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "republicano",
                "label": "republicano",
                "word": "republican"
              }
            ]
          },
          {
            "id": "organizations",
            "label": "Organizations",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "partido",
                "label": "partido",
                "word": "party"
              }
            ]
          },
          {
            "id": "elections",
            "label": "Elections",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "elección",
                "label": "elección",
                "word": "election"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef5"
        }
      },
      {
        "id": "countries",
        "label": "Countries",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "china",
            "label": "China",
            "word": "china"
          },
          {
            "id": "irán",
            "label": "Irán",
            "word": "iran"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef6"
        }
      },
      {
        "id": "conjunctions",
        "label": "Conjunctions",
        "color": "#ccc",
        "subclusters": [],
        "words": [
          {
            "id": "o",
            "label": "o",
            "word": "or"
          }
        ],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef7"
        }
      },
      {
        "id": "adverbs",
        "label": "Adverbs",
        "color": "#ccc",
        "subclusters": [
          {
            "id": "criminally",
            "label": "Criminally",
            "color": "#ccc",
            "subclusters": [],
            "words": [
              {
                "id": "corruptamente",
                "label": "corruptamente",
                "word": "corruptly"
              }
            ]
          }
        ],
        "words": [],
        "_id": {
          "$oid": "674d818801a80f325c3f8ef8"
        }
      }
    ],
    "_id": {
      "$oid": "674d818801a80f325c3f8ee8"
    }
  }


  const nodeHierarchy = new Map();
const nodeParents = new Map();
const breadcrumbHistory = [];

function findNodeInData(id, clusters) {
    for (const cluster of clusters) {
        if (cluster.id === id) return cluster;
        if (cluster.subclusters) {
            const found = findNodeInData(id, cluster.subclusters);
            if (found) return found;
        }
        if (cluster.words) {
            const found = cluster.words.find(word => word.id === id);
            if (found) return found;
        }
    }
    return null;
}

function buildNodeHierarchy(clusters, parentId = null) {
    clusters.forEach(cluster => {
        nodeHierarchy.set(cluster.id, cluster);
        if (parentId) nodeParents.set(cluster.id, parentId);
        
        if (cluster.subclusters) {
            buildNodeHierarchy(cluster.subclusters, cluster.id);
        }
        if (cluster.words) {
            cluster.words.forEach(word => {
                nodeHierarchy.set(word.id, word);
                nodeParents.set(word.id, cluster.id);
            });
        }
    });
}

function generateNodesAndEdges(node) {
    const nodes = new Set();
    const edges = new Set();
    const addedNodeIds = new Set();

    function addUniqueNode(nodeData) {
        if (!addedNodeIds.has(nodeData.id)) {
            nodes.add(nodeData);
            addedNodeIds.add(nodeData.id);
        }
    }

    function addUniqueEdge(edgeData) {
        const edgeKey = `${edgeData.from}-${edgeData.to}`;
        edges.add(edgeData);
    }

    addUniqueNode({
        id: node.id,
        label: node.label || node.id,
        title: node.word || '', 
        color: {
            background: node.color || '#2c3e50',
            border: '#fff'
        },
        font: { color: '#fff', size: 16 },
        size: 30
    });

    if (node.subclusters) {
        node.subclusters.forEach(subcluster => {
            addUniqueNode({
                id: subcluster.id,
                label: subcluster.label,
                title: subcluster.word || '',
                color: {
                    background: subcluster.color || '#ccc',
                    border: '#fff'
                },
                font: { color: '#fff', size: 16 },
                size: 25
            });
            addUniqueEdge({
                from: node.id,
                to: subcluster.id,
                color: { color: '#bdc3c7' }
            });
        });
    }

    if (node.words) {
        node.words.forEach(word => {
            addUniqueNode({
                id: word.id,
                label: word.label,
                title: word.word || '',
                color: {
                    background: '#95a5a6',
                    border: '#fff'
                },
                font: { color: '#fff', size: 14 },
                size: 20
            });
            addUniqueEdge({
                from: node.id,
                to: word.id,
                color: { color: '#bdc3c7' }
            });
        });
    }

    if (node.id === 'root') {
        graphData.clusters.forEach(cluster => {
            addUniqueNode({
                id: cluster.id,
                label: cluster.label,
                title: cluster.word || '',
                color: {
                    background: cluster.color || '#2c3e50',
                    border: '#fff'
                },
                font: { color: '#fff', size: 16 },
                size: 30
            });
        });
    }

    return { 
        nodes: Array.from(nodes), 
        edges: Array.from(edges) 
    };
}

function createRootNode() {
    return {
        id: 'root',
        label: 'All Clusters',
        color: '#34495e',
        subclusters: graphData.clusters
    };
}

buildNodeHierarchy(graphData.clusters);

const container = document.getElementById('network');
const data = {
    nodes: new vis.DataSet([]),
    edges: new vis.DataSet([])
};

const options = {
    physics: {
        enabled: true,
        stabilization: true,
        barnesHut: { 
            gravitationalConstant: -2000,
            springLength: 150,
            springConstant: 0.04
        }
    },
    nodes: {
        shape: 'circle',
        borderWidth: 2,
        font: {
            size: 16,
            face: 'arial'
        }
    },
    edges: {
        width: 2,
        arrows: {
            to: { enabled: true, scaleFactor: 0.5 }
        },
        smooth: {
            type: 'continuous'
        }
    },
    interaction: {
        hover: true,
        tooltipDelay: 200
    }
};

const network = new vis.Network(container, data, options);

function updateBreadcrumb() {
    const breadcrumbDiv = document.getElementById('breadcrumb');
    breadcrumbDiv.innerHTML = breadcrumbHistory.map((node, index) => {
        const text = `<span class="breadcrumb-item" data-id="${node.id}">${node.label || node.id}</span>`;
        return index < breadcrumbHistory.length - 1 
            ? text + '<span class="breadcrumb-separator">></span>' 
            : text;
    }).join('');

    document.querySelectorAll('.breadcrumb-item').forEach(item => {
        item.addEventListener('click', function() {
            const nodeId = this.dataset.id;
            const node = nodeHierarchy.get(nodeId);
            const index = breadcrumbHistory.findIndex(n => n.id === nodeId);
            breadcrumbHistory.splice(index + 1);
            showNode(node);
        });
    });
}

function showNode(node) {
    if (!node) {
        node = createRootNode();
    }


    if (!breadcrumbHistory.find(n => n.id === node.id)) {
        breadcrumbHistory.push(node);
    }
    updateBreadcrumb();

    const { nodes, edges } = generateNodesAndEdges(node);
    data.nodes.clear();
    data.edges.clear();
    data.nodes.add(nodes);
    data.edges.add(edges);

    network.fit({
        animation: {
            duration: 1000,
            easingFunction: 'easeInOutQuad'
        }
    });
}

network.on('click', function(params) {
    if (params.nodes.length > 0) {
        const clickedNodeId = params.nodes[0];
        const clickedNode = nodeHierarchy.get(clickedNodeId);
        
        if (clickedNode && (clickedNode.subclusters || clickedNode.words)) {
            showNode(clickedNode);
        }
    }
});

showNode(createRootNode());